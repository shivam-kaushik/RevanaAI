<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Sales Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../static/css/main.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-top">
                <div class="header-title-block">
                    <h1>ü§ñ Agentic Sales Assistant</h1>
                    <p>Conversational analytics on top of your sales datasets</p>
                    <div class="header-subtitle-role">
                        {% if role == 'admin' %}
                            You are in <strong>Admin</strong> mode ‚Äì manage datasets and run advanced analytics.
                        {% elif role == 'sales' %}
                            You are in <strong>Sales</strong> mode ‚Äì chat with the assistant and explore insights.
                        {% elif role == 'customer' %}
                            You are in <strong>Customer</strong> mode ‚Äì ask high-level questions about performance.
                        {% else %}
                            Not signed in ‚Äì please <strong>log in</strong> to access the assistant.
                        {% endif %}
                    </div>
                </div>

                <div class="header-user-block">
                    {% if user %}
                        <span class="role-pill">
                            {{ user.role|capitalize }} view
                        </span>
                        <span class="user-name">
                            Signed in as <strong>{{ user.username }}</strong>
                        </span>
                        <a href="/logout" class="nav-link-btn">Logout</a>
                    {% else %}
                        <a href="/login" class="nav-link-btn">Login</a>
                    {% endif %}
                </div>
            </div>
        </header>

        <main class="main-content {% if role == 'admin' %}admin-layout{% else %}chat-layout{% endif %}">

            {% if role == 'admin' %}
            <!-- ========== ADMIN DASHBOARD ONLY ========== -->
            <section class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Upload Your CSV File</h3>
                    <p>Drag &amp; drop your CSV file here or click to browse</p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv">
                    <button class="upload-btn" id="uploadBtn">
                        Choose File
                    </button>
                </div>

                <div id="uploadStatus"></div>

                <div class="dataset-info" id="datasetInfo" style="display: none;">
                    <h4>üìä Active Dataset</h4>
                    <div id="datasetDetails"></div>
                </div>

                <div class="dataset-management" id="datasetManagement" style="display:none;">
                    <h4>üìä Dataset Management</h4>
                    
                    <div class="active-dataset" id="activeDatasetInfo">
                        <strong>Active Dataset:</strong> <span id="activeDatasetName">None</span>
                    </div>
                    
                    <div class="dataset-list" style="margin-top: 10px;">
                        <label><strong>Available Datasets:</strong></label>
                        <select id="datasetSelect" class="dataset-select" style="width: 100%; padding: 8px; margin: 5px 0;">
                            <option value="">Select a dataset...</option>
                        </select>
                        <button class="upload-btn" id="setActiveBtn" style="margin-top: 5px;">Set as Active</button>
                    </div>
                </div>

                <div class="status-area" id="systemStatus">
                    <h4>System Status</h4>
                    <div id="statusMessage">Checking system status...</div>
                </div>

                <!-- ========== ADMIN: USER MANAGEMENT ========== -->
                <div class="user-management-card">
                    <h4>üë• User Management</h4>

                    <div class="form-row">
                        <label for="newUsername"><strong>Username</strong></label>
                        <input type="text" id="newUsername" class="text-input" placeholder="e.g., john_doe">
                    </div>

                    <div class="form-row">
                        <label for="newPassword"><strong>Password</strong></label>
                        <input type="password" id="newPassword" class="text-input" placeholder="Set a password">
                    </div>

                    <div class="form-row">
                        <label for="newRole"><strong>Role</strong></label>
                        <select id="newRole" class="dataset-select">
                            <option value="sales">Sales</option>
                            <option value="customer">Customer</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <button class="upload-btn" id="createUserBtn" style="margin-top: 8px;">Create User</button>

                    <div id="userStatus" class="small-status-text" style="margin-top: 6px;"></div>
                </div>
            </section>
            {% else %}
            <!-- ========== SALES / CUSTOMER: FULL-WIDTH CHAT ONLY ========== -->
            <section class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant-message">
                        <strong>ü§ñ Assistant</strong><br>
                        {% if role == 'sales' %}
                            Welcome, Sales! Your admin has prepared datasets for you. Ask questions like:
                        {% else %}
                            Welcome! Once a dataset is configured, you can ask questions about overall performance.
                        {% endif %}
                        <div class="analysis-mode">
                            <strong>Try asking:</strong><br>
                            ‚Ä¢ "Show me total sales by month"<br>
                            ‚Ä¢ "What are the top 5 products by revenue?"<br>
                            ‚Ä¢ "Analyze sales trends over time"<br>
                            ‚Ä¢ "Compare sales between genders"
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your data..." disabled>
                    <button class="send-btn" id="sendBtn" disabled>Send</button>
                </div>
            </section>
            {% endif %}

        </main>
    </div>

    <script>
        // ===== DOM Elements =====
        const fileInput      = document.getElementById('fileInput');
        const uploadBtn      = document.getElementById('uploadBtn');
        const uploadArea     = document.getElementById('uploadArea');
        const uploadStatus   = document.getElementById('uploadStatus');
        const systemStatus   = document.getElementById('systemStatus');
        const statusMessage  = document.getElementById('statusMessage');
        const datasetInfo    = document.getElementById('datasetInfo');
        const datasetDetails = document.getElementById('datasetDetails');
        const chatMessages   = document.getElementById('chatMessages');
        const chatInput      = document.getElementById('chatInput');
        const sendBtn        = document.getElementById('sendBtn');

        // State
        let currentDataset = null;
        let isUploading = false;

        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            setupEventListeners();
            loadDatasets();

            const setActiveBtn = document.getElementById('setActiveBtn');
            const datasetSelect = document.getElementById('datasetSelect');
            
            if (setActiveBtn) {
                setActiveBtn.addEventListener('click', function() {
                    const selectedDataset = datasetSelect.value;
                    if (selectedDataset) {
                        setActiveDataset(selectedDataset);
                    }
                });
            }
        });

        // ===== Event Listeners Setup =====
        function setupEventListeners() {
            // File input change (admin only, element may not exist)
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }

            // Drag and drop (admin only)
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('highlight');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('highlight');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('highlight');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && fileInput) {
                        fileInput.files = files;
                        handleFileSelect();
                    }
                });

                uploadArea.addEventListener('click', () => {
                    if (fileInput) fileInput.click();
                });
            }

            // Chat input
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Send button
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }

            // Dataset management (admin only)
            const setActiveBtn   = document.getElementById('setActiveBtn');
            const datasetSelect  = document.getElementById('datasetSelect');

            if (setActiveBtn && datasetSelect) {
                setActiveBtn.addEventListener('click', function() {
                    const selectedDataset = datasetSelect.value;
                    if (selectedDataset) {
                        setActiveDataset(selectedDataset);
                    }
                });
            }

            // User management (admin only)
            const createUserBtn = document.getElementById('createUserBtn');
            const newUsername   = document.getElementById('newUsername');
            const newPassword   = document.getElementById('newPassword');
            const newRole       = document.getElementById('newRole');
            const userStatus    = document.getElementById('userStatus');

            if (createUserBtn && newUsername && newPassword && newRole && userStatus) {
                createUserBtn.addEventListener('click', async () => {
                    const username = newUsername.value.trim();
                    const password = newPassword.value.trim();
                    const role     = newRole.value;

                    if (!username || !password) {
                        userStatus.textContent = "Please enter username and password.";
                        userStatus.style.color = "#cc0000";
                        return;
                    }

                    try {
                        createUserBtn.disabled = true;
                        userStatus.textContent = "Creating user...";
                        userStatus.style.color = "#555";

                        const resp = await fetch('/admin/users', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password, role })
                        });

                        const result = await resp.json();

                        if (result.success) {
                            userStatus.textContent = result.message || "User created successfully.";
                            userStatus.style.color = "#28a745";
                            newPassword.value = "";
                        } else {
                            userStatus.textContent = result.error || "Failed to create user.";
                            userStatus.style.color = "#cc0000";
                        }
                    } catch (err) {
                        console.error('Create user error:', err);
                        userStatus.textContent = "Error creating user.";
                        userStatus.style.color = "#cc0000";
                    } finally {
                        createUserBtn.disabled = false;
                    }
                });
            }
        }

        // ===== File Upload Handling (Admin) =====
        function handleFileSelect() {
            if (!fileInput) return;
            const file = fileInput.files[0];
            if (file) {
                if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                    showStatus('Please select a CSV file.', 'error');
                    return;
                }
                uploadFile(file);
            }
        }

        async function uploadFile(file) {
            if (isUploading) return;
            isUploading = true;
            updateUploadButton(true);
            showStatus('Uploading file...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const msg = result.message || 'File uploaded successfully.';
                    showStatus(msg, 'success');

                    // Update the dataset info display
                    if (result.dataset_info) {
                        currentDataset = result.dataset_info;
                        updateDatasetInfo(result.dataset_info);
                    }

                    // Reload the datasets list
                    await loadDatasets();
                    enableChat();
                    await checkHealth();
                } else {
                    const msg = result.message || result.error || 'Upload failed.';
                    showStatus(msg, 'error');
                }

            } catch (error) {
                console.error('Upload error:', error);
                showStatus('Upload failed: ' + error.message, 'error');
            } finally {
                isUploading = false;
                updateUploadButton(false);
            }
        }

        function updateUploadButton(uploading) {
            if (uploadBtn) {
                uploadBtn.disabled = uploading;
                uploadBtn.textContent = uploading ? 'Uploading...' : 'Choose File';
            }
        }

        function showStatus(message, type = 'info') {
            if (!uploadStatus) return;
            uploadStatus.innerHTML = `
                <div class="status-${type}">
                    <strong>${type.toUpperCase()}:</strong> ${message}
                </div>
            `;
        }

        function updateDatasetInfo(info) {
            if (!datasetInfo || !datasetDetails) return;

            datasetInfo.style.display = 'block';
            datasetDetails.innerHTML = `
                <p><strong>Table:</strong> ${info.table_name || 'N/A'}</p>
                <p><strong>Records:</strong> ${info.row_count || 0} rows</p>
                <p><strong>Columns:</strong> ${info.column_count || 0}</p>
                <p><strong>Database:</strong> ${info.database || 'PostgreSQL'}</p>
                ${info.columns ? `<p><strong>Columns:</strong> ${info.columns.join(', ')}</p>` : ''}
            `;
        }

        function enableChat() {
            if (chatInput && sendBtn) {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.placeholder = "Ask about your sales data (e.g., 'show me total sales by month')...";
            }
        }

        // ---------- Semantic vs SQL routing ----------

        const semanticKeywords = [
            'similar', 'like', 'recommend', 'find products like', 'customers like',
            'comparable', 'alternative', 'semantic', 'vector'
        ];

        function isSemanticQuery(message) {
            return semanticKeywords.some(keyword =>
                message.toLowerCase().includes(keyword)
            );
        }

        async function sendMessage() {
            if (!chatInput || !sendBtn) return;

            const message = chatInput.value.trim();
            if (!message || sendBtn.disabled) return;

            const dataKeywords = [
                'show', 'analyze', 'trend', 'chart', 'graph', 'sales', 'revenue',
                'total', 'average', 'sum', 'count', 'by month', 'by category',
                'compare', 'distribution', 'top', 'highest', 'lowest'
            ];

            const isDataQuery = dataKeywords.some(keyword => message.toLowerCase().includes(keyword));
            const isSemantic  = isSemanticQuery(message);

            if (isSemantic && currentDataset) {
                await semanticSearch(message);
            } else if (isDataQuery && currentDataset) {
                await analyzeData();
            } else {
                await sendRegularMessage();
            }
        }

        // ===== Semantic Search (Admin-only endpoint, but guarded by backend) =====
        async function semanticSearch(message) {
            addMessage(message, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            const typingId = showTypingIndicator();

            try {
                const response = await fetch('/semantic-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: 'default'
                    })
                });

                const result = await response.json();
                removeTypingIndicator(typingId);

                if (result.success) {
                    addMessage(result.response, 'assistant');
                } else {
                    addMessage(`‚ùå ${result.error}`, 'assistant');
                }
            } catch (error) {
                console.error('Semantic search error:', error);
                removeTypingIndicator(typingId);
                addMessage('Sorry, I encountered an error during semantic search.', 'assistant');
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ===== Dataset Management (Admin) =====
        async function loadDatasets() {
            try {
                const response = await fetch('/datasets');
                const result = await response.json();

                if (result.success) {
                    updateDatasetUI(result.datasets || [], result.active_dataset || null);
                }
            } catch (error) {
                console.error('Error loading datasets:', error);
            }
        }

        function updateDatasetUI(datasets, activeDataset) {
            const datasetManagement = document.getElementById('datasetManagement');
            const activeDatasetName = document.getElementById('activeDatasetName');
            const datasetSelect     = document.getElementById('datasetSelect');

            // Even if there is no datasetManagement (sales/customer view),
            // we still want to track active dataset to enable chat.
            if (activeDataset) {
                currentDataset = activeDataset;
                enableChat();
            }

            if (!datasetManagement || !activeDatasetName || !datasetSelect) {
                return; // Non-admin view: no dataset UI to manage
            }

            if (datasets.length > 0) {
                datasetManagement.style.display = 'block';
                if (activeDataset) {
                    activeDatasetName.textContent = `${activeDataset.table_name} (${activeDataset.row_count} rows)`;
                } else {
                    activeDatasetName.textContent = 'None';
                }
                datasetSelect.innerHTML = '<option value="">Select a dataset...</option>';
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.table_name;
                    option.textContent = `${dataset.table_name} (${dataset.row_count} rows)`;
                    if (activeDataset && dataset.table_name === activeDataset.table_name) {
                        option.selected = true;
                    }
                    datasetSelect.appendChild(option);
                });
            } else {
                datasetManagement.style.display = 'none';
            }
        }

        async function setActiveDataset(tableName) {
            try {
                const response = await fetch('/datasets/active', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_name: tableName })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`Dataset '${tableName}' is now active`, 'success');
                    await loadDatasets();
                } else {
                    showStatus(`Failed to set active dataset: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error setting active dataset:', error);
                showStatus('Error setting active dataset', 'error');
            }
        }

        // ===== User Management (Admin) =====
        async function createUser() {
            const usernameInput = document.getElementById('newUsername');
            const passwordInput = document.getElementById('newPassword');
            const roleSelect    = document.getElementById('newRole');
            const userStatus    = document.getElementById('userStatus');

            if (!usernameInput || !passwordInput || !roleSelect || !userStatus) return;

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const role     = roleSelect.value;

            if (!username || !password) {
                userStatus.textContent = 'Please enter both username and password.';
                userStatus.style.color = '#dc3545';
                return;
            }

            try {
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });

                const result = await response.json();

                if (result.success) {
                    userStatus.textContent = `User "${username}" created with role "${role}".`;
                    userStatus.style.color = '#28a745';
                    usernameInput.value = '';
                    passwordInput.value = '';
                    roleSelect.value = 'sales';
                } else {
                    userStatus.textContent = result.error || 'Failed to create user.';
                    userStatus.style.color = '#dc3545';
                }
            } catch (err) {
                console.error('Create user error:', err);
                userStatus.textContent = 'Error creating user: ' + err.message;
                userStatus.style.color = '#dc3545';
            }
        }

        // ===== Health Check =====
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const result = await response.json();

                if (statusMessage) {
                    let statusHTML = `<span style="color: #28a745;">‚úÖ ${result.message}</span><br>`;
                    statusHTML += `<small>Database: ${result.database || 'PostgreSQL'}</small><br>`;
                    statusHTML += `<small>Active Datasets: ${result.available_datasets_count || 0}</small>`;

                    if (result.active_dataset) {
                        statusHTML += `<br><small>Active: ${result.active_dataset.table_name}</small>`;
                    }
                    statusMessage.innerHTML = statusHTML;
                }

                // If there is an active dataset, enable chat for all roles
                if (result.active_dataset) {
                    currentDataset = result.active_dataset;
                    enableChat();
                }

                // Also refresh dataset UI (for admin)
                await loadDatasets();

            } catch (error) {
                console.error('Health check failed:', error);
                if (statusMessage) {
                    statusMessage.innerHTML = `<span style="color: #dc3545;">‚ùå Service unavailable</span>`;
                }
            }
        }

        setInterval(checkHealth, 30000); // every 30 seconds

        // ===== Chat / Analysis Functions =====
        async function sendRegularMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            const typingId = showTypingIndicator();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: 'default'
                    })
                });

                const result = await response.json();
                removeTypingIndicator(typingId);
                addMessage(result.response, 'assistant', result);
            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator(typingId);
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        async function analyzeData() {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            const typingId = showTypingIndicator();

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: 'default'
                    })
                });

                const result = await response.json();
                removeTypingIndicator(typingId);

                if (result.success) {
                    addMessage(result.response, 'assistant');

                    if (result.charts && Object.keys(result.charts).length > 0) {
                        displayCharts(result.charts);
                    }
                } else {
                    const errText =
                        result.error ||
                        result.message ||
                        'Analysis failed ‚Äì no error message returned.';
                    addMessage(`‚ùå ${errText}`, 'assistant');
                }

            } catch (error) {
                console.error('Analysis error:', error);
                removeTypingIndicator(typingId);
                addMessage('Sorry, I encountered an error during analysis. Please try again.', 'assistant');
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        function displayCharts(charts) {
            if (!chatMessages) return;

            const chartsDiv = document.createElement('div');
            chartsDiv.className = 'message assistant-message';
            chartsDiv.innerHTML = '<strong>üìà Generated Charts:</strong><br>';

            Object.entries(charts).forEach(([chartType, chartData]) => {
                if (chartData) {
                    const chartTitle = getChartTitle(chartType);
                    chartsDiv.innerHTML += `
                        <div class="chart-container">
                            <div class="chart-title">${chartTitle}</div>
                            <img src="data:image/png;base64,${chartData}" class="chart-image" />
                        </div>
                    `;
                }
            });

            chatMessages.appendChild(chartsDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getChartTitle(chartType) {
            const titles = {
                'trend': 'üìà Trend Analysis',
                'bar': 'üìä Category Comparison',
                'pie': 'ü•ß Distribution',
                'distribution': 'üìã Data Distribution',
                'forecast_combined': 'üîÆ Forecast Overview'
            };
            return titles[chartType] || 'Chart';
        }

        // ---------- Messaging helpers + FEEDBACK ----------

        function addMessage(content, sender, metadata = null) {
            if (!chatMessages) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            let messageHTML = `<strong>${sender === 'user' ? 'üë§ You' : 'ü§ñ Assistant'}</strong><br>`;
            messageHTML += formatMessageContent(content);

            if (metadata && sender === 'assistant') {
                if (metadata.agents_used && metadata.agents_used.length > 0) {
                    messageHTML += `<br><small>Agents: ${metadata.agents_used.map(agent => `<span class="agent-tag">${agent}</span>`).join('')}</small>`;
                }
                if (metadata.has_dataset) {
                    messageHTML += `<br><small>üìä Using uploaded dataset</small>`;
                }
            }

            messageDiv.innerHTML = messageHTML;
            chatMessages.appendChild(messageDiv);

            // If backend sent an interaction_id, render rating widget
            if (sender === 'assistant' && metadata && metadata.interaction_id) {
                renderFeedbackWidget(messageDiv, metadata.interaction_id);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessageContent(content) {
            return content
                .replace(/!\[(.*?)\]\((.*?)\)/g, '<br><img src="$2" alt="$1" class="chart-image"><br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            if (!chatMessages) return null;
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <strong>ü§ñ Assistant</strong><br>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return 'typing-indicator';
        }

        function removeTypingIndicator(id) {
            if (!id) return;
            const element = document.getElementById(id);
            if (element) element.remove();
        }

        // ----- Rating widget -----

        function renderFeedbackWidget(messageDiv, interactionId) {
            if (!interactionId) return;

            const existing = messageDiv.querySelector('.feedback-widget');
            if (existing) return;

            const container = document.createElement('div');
            container.className = 'feedback-widget';
            container.innerHTML = `
                <div class="feedback-title">How helpful was this answer?</div>
                <div class="feedback-stars">
                    <span data-rating="1">‚òÖ</span>
                    <span data-rating="2">‚òÖ</span>
                    <span data-rating="3">‚òÖ</span>
                    <span data-rating="4">‚òÖ</span>
                    <span data-rating="5">‚òÖ</span>
                </div>
                <div class="feedback-status"></div>
            `;

            const stars = container.querySelectorAll('.feedback-stars span');
            const statusEl = container.querySelector('.feedback-status');

            stars.forEach(star => {
                star.addEventListener('click', async () => {
                    const rating = parseInt(star.dataset.rating, 10);
                    await submitFeedback(interactionId, rating, container, statusEl);

                    stars.forEach(s => s.classList.remove('selected'));
                    for (let i = 0; i < rating; i++) {
                        stars[i].classList.add('selected');
                    }
                });
            });

            messageDiv.appendChild(container);
        }

        async function submitFeedback(interactionId, rating, container, statusEl) {
            if (!interactionId || !rating || !container) return;
            if (container.dataset.submitted === 'true') return;

            try {
                const response = await fetch('/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interaction_id: interactionId,
                        rating: rating,
                        comment: null
                    })
                });

                const result = await response.json();
                if (result.success) {
                    container.dataset.submitted = 'true';
                    if (statusEl) {
                        statusEl.textContent = 'Thanks for your feedback!';
                        statusEl.className = 'feedback-status success';
                    }
                } else {
                    if (statusEl) {
                        statusEl.textContent = 'Could not save feedback.';
                        statusEl.className = 'feedback-status error';
                    }
                }
            } catch (err) {
                console.error('Feedback error:', err);
                if (statusEl) {
                    statusEl.textContent = 'Error sending feedback.';
                    statusEl.className = 'feedback-status error';
                }
            }
        }

    </script>
</body>
</html>
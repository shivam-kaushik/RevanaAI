<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revana AI - Sales Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo-container">
                <img src="/static/image.png" alt="Revana Logo" class="app-logo">
                <span class="logo-text">Revana</span>
            </div>
            
            <button class="new-chat-btn" onclick="location.reload()">
                <span>+</span> New Chat
            </button>
            
            <nav class="nav-links">
                <a href="#" class="nav-item active">
                    <span>üí¨</span> Chat
                </a>
                {% if role == 'admin' %}
                <!-- Admin Tools -->
                <a href="#" onclick="document.getElementById('upload-modal').style.display='flex'" class="nav-item">
                    <span>üìÅ</span> Upload Dataset
                </a>
                <a href="#" onclick="handleOpenDatasets()" class="nav-item">
                    <span>üìö</span> Datasets
                </a>
                <a href="#" onclick="document.getElementById('user-modal').style.display='flex'" class="nav-item">
                    <span>üë•</span> User Mgmt
                </a>
                {% endif %}
            </nav>
            
            <div class="user-profile">
                <!-- Initials Avatar -->
                <div class="avatar">{{ user.username[:2].upper() if user else '?' }}</div>
                <div style="flex: 1; overflow: hidden;">
                    <div style="font-weight: 500; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ user.username if user else 'Guest' }}
                    </div>
                    <div style="font-size: 0.75em; color: var(--text-secondary);">
                        {{ role|capitalize if role else '' }}
                    </div>
                </div>
                <!-- Logout Icon -->
                <a href="/logout" title="Logout" style="color: var(--text-secondary); text-decoration: none; padding: 4px;">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </a>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <div id="chat-container" class="chat-container">
                <!-- Welcome Screen (Only visible initially) -->
                <div class="welcome-screen animate-entry">
                    <img src="/static/image.png" alt="Revana Logo" class="welcome-logo">
                    <h1 class="welcome-title">Revana Sales Assistant</h1>
                    <p>Ask me about sales trends, anomalies, or forecasts.</p>
                    
                    <div class="feature-grid">
                        <div class="feature-card btn-3d" onclick="setQuery('Show me sales trend over time')">
                            <h3>üìà Sales Trend</h3>
                            <p>"Show me sales trend over time"</p>
                        </div>
                        <div class="feature-card btn-3d" onclick="setQuery('Are there any anomalies in sales?')">
                            <h3>üö® Anomalies</h3>
                            <p>"Any anomalies in sales?"</p>
                        </div>
                        <div class="feature-card btn-3d" onclick="setQuery('Forecast sales for next month')">
                            <h3>üîÆ Forecast</h3>
                            <p>"Forecast sales for next month"</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="user-input" class="chat-input" placeholder="Send a message..." rows="1" onkeydown="handleEnter(event)"></textarea>
                    <button class="send-btn" onclick="sendMessage()">
                        <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
                <div style="text-align: center; font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Revana AI may produce inaccurate information about people, places, or facts.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Modal -->
    <div id="upload-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--bg-secondary); padding:2rem; border-radius:8px; width:400px; box-shadow:var(--shadow-lg); border: 1px solid var(--border-color);">
            <h2 style="margin-bottom:1rem;">Upload Dataset</h2>
            <form id="upload-form" onsubmit="handleUpload(event)">
                <div style="margin-bottom: 1rem; border: 2px dashed var(--border-color); padding: 2rem; text-align: center; border-radius: 6px; position: relative;">
                    <input type="file" id="file-input" accept=".csv" required style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;">
                    <p style="color: var(--text-secondary);">Click or drag CSV here</p>
                    <div id="file-name-display" style="margin-top: 0.5rem; font-weight: bold; color: var(--accent-color);"></div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                    <button type="button" onclick="document.getElementById('upload-modal').style.display='none'" style="background:transparent; border:1px solid var(--border-color); color:var(--text-primary); padding:0.5rem 1rem; border-radius:4px; cursor:pointer;">Cancel</button>
                    <button type="submit" class="btn-3d">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dataset Selection Modal -->
    <div id="dataset-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="modal-content" style="background:var(--bg-secondary); padding:2rem; border-radius:8px; width:600px; box-shadow:var(--shadow-lg); border: 1px solid var(--border-color);">
            <h2 style="margin-bottom:1rem;">Select Active Dataset</h2>
            <div id="dataset-list" style="max-height: 400px; overflow-y: auto; margin: 1rem 0;">
                <!-- Datasets injected here -->
                <div class="dataset-item-loading">Loading datasets...</div>
            </div>
            <div class="modal-actions" style="display:flex; justify-content:flex-end;">
                <button type="button" onclick="document.getElementById('dataset-modal').style.display='none'" style="background:transparent; border:1px solid var(--border-color); color:var(--text-primary); padding:0.5rem 1rem; border-radius:4px; cursor:pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="user-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--bg-secondary); padding:2rem; border-radius:8px; width:400px; box-shadow:var(--shadow-lg); border: 1px solid var(--border-color);">
            <h2 style="margin-bottom:1rem;">Create User</h2>
            <form onsubmit="handleCreateUser(event)">
                <input type="text" id="new-username" placeholder="Username" required style="width: 100%; padding: 0.75rem; margin-bottom: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: white; border-radius: 4px;">
                <input type="password" id="new-password" placeholder="Password" required style="width: 100%; padding: 0.75rem; margin-bottom: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: white; border-radius: 4px;">
                <select id="new-role" style="width: 100%; padding: 0.75rem; margin-bottom: 1.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: white; border-radius: 4px;">
                    <option value="sales">Sales</option>
                    <option value="customer">Customer</option>
                    <option value="admin">Admin</option>
                </select>
                <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                    <button type="button" onclick="document.getElementById('user-modal').style.display='none'" style="background:transparent; border:1px solid var(--border-color); color:var(--text-primary); padding:0.5rem 1rem; border-radius:4px; cursor:pointer;">Cancel</button>
                    <button type="submit" class="btn-3d">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');

        // --- Event Listeners ---
        
        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // File input display name
        if(fileInput) {
            fileInput.addEventListener('change', function(e) {
                if(e.target.files[0]) {
                    document.getElementById('file-name-display').textContent = e.target.files[0].name;
                }
            });
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function setQuery(text) {
            userInput.value = text;
            sendMessage();
        }

        // --- Chat Functions ---

        function appendMessage(role, content, isHtml = false) {
            // Remove welcome screen if it exists
            const welcomeScreen = document.querySelector('.welcome-screen');
            if (welcomeScreen) welcomeScreen.remove();

            const msgDiv = document.createElement('div');
            msgDiv.className = `message-row ${role}`;
            
            // Avatar logic
            let avatar = '';
            if (role === 'assistant') {
                avatar = '<img src="/static/image.png" class="message-avatar">';
            } else {
                // User avatar (simple initial)
                avatar = '<div class="message-avatar" style="background: var(--accent-color); color: white; display:flex; align-items:center; justify-content:center; border-radius:2px; font-weight:bold;">U</div>';
            }

            msgDiv.innerHTML = `
                <div class="message-content">
                    ${avatar}
                    <div class="message-text">${isHtml ? content : escapeHtml(content)}</div>
                </div>
            `;
            
            chatContainer.appendChild(msgDiv);
            
            // Scroll to bottom
            // We scroll the main-content (parent of chat-container's messages) or chat-container itself?
            // In CSS: .chat-container is overflow-y: auto.
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            // Remove welcome screen if still there
            const welcomeScreen = document.querySelector('.welcome-screen');
            if (welcomeScreen) welcomeScreen.remove();

            const id = 'typing-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message-row assistant';
            msgDiv.id = id;
            msgDiv.innerHTML = `
                <div class="message-content">
                    <img src="/static/image.png" class="message-avatar">
                    <div class="message-text">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // Clear input
            userInput.value = '';
            userInput.style.height = 'auto';

            // User Message
            appendMessage('user', text);

            // Typing Indicator
            const typingId = showTyping();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                
                const data = await response.json();
                removeTyping(typingId);

                if (data.error) {
                    appendMessage('assistant', '<span style="color:var(--error-color)">Error: ' + data.error + '</span>', true);
                } else {
                    // Render response: text + any plots
                    let finalHtml = marked.parse(data.response || "");
                    
                    // Append charts if any
                    if (data.plot_html) {
                        finalHtml += `<div style="margin-top:1rem; border:1px solid var(--border-color); border-radius:8px; padding:10px; background:white; color:black;">${data.plot_html}</div>`;
                    }
                    if (data.charts && data.charts.length > 0) { // Legacy support
                         data.charts.forEach(chart => {
                            finalHtml += `<img src="data:image/png;base64,${chart}" style="max-width:100%; margin-top:1rem; border-radius:8px;">`;
                         });
                    }

                    appendMessage('assistant', finalHtml, true);
                    
                    // Re-evaluate scripts for Plotly in the last added message
                    // We need to find the scripts recursively in the last message-row
                    const lastMsg = chatContainer.lastElementChild;
                    if(lastMsg) {
                        const scripts = lastMsg.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    }
                }

            } catch (err) {
                removeTyping(typingId);
                appendMessage('assistant', 'Connection error. Please check your network.', false);
                console.error(err);
            }
        }

        // --- Admin Functions ---

        async function handleUpload(e) {
            e.preventDefault();
            const input = document.getElementById('file-input');
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            
            // Change button text to show loading
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = "Uploading...";
            btn.disabled = true;

            try {
                const res = await fetch('/upload', { method:'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    alert("Upload Successful!");
                    document.getElementById('upload-modal').style.display = 'none';
                    location.reload(); 
                } else {
                    alert("Upload Failed: " + (data.message || data.error));
                }
            } catch(err) {
                alert("Upload Error: " + err);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            try {
                const res = await fetch('/admin/users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password, role })
                });
                const data = await res.json();
                if(data.success) {
                    alert("User Created!");
                    document.getElementById('user-modal').style.display = 'none';
                } else {
                    alert("Error: " + data.error);
                }
            } catch(err) {
                alert("Request Error");
            }
        }

        async function handleOpenDatasets() {
            document.getElementById('dataset-modal').style.display = 'flex';
            await loadDatasets();
        }

        async function loadDatasets() {
            const listEl = document.getElementById('dataset-list');
            listEl.innerHTML = '<div class="dataset-item-loading">Loading...</div>';
            
            try {
                const res = await fetch('/datasets');
                const data = await res.json();
                if (data.success) {
                    renderDatasetList(data.datasets, data.active_dataset);
                } else {
                    listEl.innerHTML = '<div style="color:var(--error-color)">Failed to load datasets</div>';
                }
            } catch(e) {
                listEl.innerHTML = '<div style="color:var(--error-color)">Connection error</div>';
            }
        }

        function renderDatasetList(datasets, active) {
            const listEl = document.getElementById('dataset-list');
            listEl.innerHTML = '';

            if (datasets.length === 0) {
                 listEl.innerHTML = '<div style="padding:1rem; text-align:center; color:var(--text-secondary)">No datasets found. Upload one!</div>';
                 return;
            }

            datasets.forEach(ds => {
                const div = document.createElement('div');
                const isActive = active && active.table_name === ds.table_name;
                div.className = 'dataset-item ' + (isActive ? 'active' : '');
                div.style.cssText = `
                    padding: 1rem;
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    margin-bottom: 0.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background-color: ${isActive ? 'rgba(16, 163, 127, 0.1)' : 'transparent'};
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                if(isActive) div.style.borderColor = 'var(--accent-color)';
                
                div.onclick = () => selectDataset(ds.table_name);

                div.innerHTML = `
                    <div>
                        <div style="font-weight:600; color:var(--text-primary)">${escapeHtml(ds.original_filename)}</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary)">
                            ${ds.row_count} rows ‚Ä¢ ${new Date(ds.upload_date).toLocaleDateString()}
                        </div>
                    </div>
                    ${isActive ? '<span style="color:var(--accent-color); font-weight:bold;">Active</span>' : ''}
                `;
                listEl.appendChild(div);
            });
        }

        async function selectDataset(tableName) {
            try {
                const res = await fetch('/datasets/active', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ table_name: tableName })
                });
                const data = await res.json();
                if (data.success) {
                    // Refresh list to show new active
                    await loadDatasets();
                    // Optional: Close modal automatically? No, let user verify.
                    // alert("Active dataset updated: " + data.active_dataset.original_filename); 
                    // Refresh background page content? 
                    // Maybe just update welcome message or something.
                } else {
                    alert("Failed to set active dataset: " + data.error);
                }
            } catch(e) {
                alert("Error setting active dataset");
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>